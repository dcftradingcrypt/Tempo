# CLAUDE.md — Non-negotiables / Mistake Log

## Non-negotiables (絶対遵守)
- 推測・一般論で断定しない（根拠: 実コード/実ログ/実行結果/参照URL）
- 例外の握りつぶし禁止（catchして黙殺/ログ無効化/バリデーション無効化/リトライで隠す/フィーチャーフラグで止める等）
- 安易なワークアラウンド禁止（タイムアウト増やす、リトライ増やすだけ等）
- faucet関連コードを入れない（tempo_fundAddress等）
- 仕様変更を伴う広範囲リファクタや破壊的変更禁止
- 証拠なしの原因特定・修正確定禁止

## Definition of Done
- `npm ci && npm run lint && npm test` が通る
- `npm run run:daily` が reports/ に JSON を生成する
- GitHub Actions が毎日実行し、reports/ を commit する

## Mistake Log（修正のたびに必ず追記する）
フォーマット（必須）:
- Date:
- Symptom:
- Evidence (ログ/tx/stacktrace/URL):
- Root Cause:
- Fix:
- Prevent Recurrence (テスト/チェック追加内容):
- Files Changed:
- Date: 2026-02-16
- Symptom:
  - `estimateGas` 失敗時に原因が opaque で、Tempo固有の失敗要因（TIP-403 / fee preference / max_fee pre-deduct / receipt fee fields）を run 1回で確定できなかった
- Evidence (ログ/tx/stacktrace/URL):
  - `missing revert data` で停止し、送信前判定で落とすべき条件を tx 実行経路で初めて検出していた
  - Tempo仕様URL:
    - `https://docs.tempo.xyz/protocol/tip20/spec`
    - `https://docs.tempo.xyz/protocol/tip403/spec`
    - `https://docs.tempo.xyz/protocol/fees/spec-fee`
    - `https://docs.tempo.xyz/protocol/fees/spec-fee-amm`
    - `https://docs.chainstack.com/reference/tempo-eth-gettransactionreceipt`
- Root Cause:
  - 事前確定判定の不足（TIP-403 policy / fee token preference / max_fee 残高）
  - report が receipt の `feeToken/feePayer` を必須検証しておらず、Tempo拡張項目欠落を見逃す設計だった
- Fix:
  - `FeeManager.setUserToken(alphaUSD)` を日次先頭 tx に追加
  - TIP-20 preflight (`paused/currency/transferPolicyId/isAuthorized`) を transfer/approve 前に実施
  - `max_fee = gas_limit * gas_price` を atto->micro に切り上げ変換し、alphaUSD 残高で送信前 fail
  - report を拡張し `gasUsed/effectiveGasPrice/feeToken/feePayer/receiptRaw` を各 tx に必須保存
  - 例外時に `run-*.failure.json` を保存して `step/preflight/error` を残して `exit(1)` 維持
- Prevent Recurrence (テスト/チェック追加内容):
  - `src/lib/feeMath.test.ts` で `ceil(attodollars/1e12)` 境界テストを追加
  - `src/lib/report.test.ts` で `feeToken/feePayer` 抽出必須テストを追加
- Files Changed:
  - `src/daily.ts`
  - `src/lib/report.ts`
  - `src/lib/feeMath.ts`
  - `src/lib/feeMath.test.ts`
  - `src/lib/report.test.ts`
  - `src/tempo.ts`
  - `src/abi/erc20.ts`
  - `src/abi/feeManager.ts`
  - `src/abi/tip403.ts`
  - `README.md`
  - `CLAUDE.md`

- Date: 2026-02-16
- Symptom:
  - `run:daily` が `missing revert data ... estimateGas` で終了し、原因（SINK誤設定/残高不足）を転送前に確定できなかった
- Evidence (ログ/tx/stacktrace/URL):
  - 実運用ログ: `FATAL: ... missing revert data`（送信前に `estimateGas` に失敗）
  - `SINK_ADDRESS` のゼロアドレス許容、TIP-20 prefix 送信先許容が残っていた
- Root Cause:
  - `env` バリデーションと transfer 前の残高検証が不足し、`estimateGas` 落ち時に必要メタデータが再現ログへ残らなかった
- Fix:
  - `src/lib/env.ts` で `SINK_ADDRESS` のゼロアドレスと TIP-20 プレフィックスを `throw` で即拒否
  - `src/daily.ts` で `transfer` 各トークンの `balanceOf(sender)` を取得し不足時は明示エラー
  - `src/daily.ts` で `transfer` の `estimateGas` 失敗時に token名/tokenアドレス/wallet/sink/amount/balance/nonce/feeFields を再現可能なエラーメッセージでログ再送
- Prevent Recurrence (テスト/チェック追加内容):
  - `src/lib/env.test.ts` にゼロ/`TIP-20 prefix`拒否ケースを追加
  - `src/daily.ts` の transfer で `balance` ログと `estimateGas` コンテキストログを維持
- Files Changed:
  - `src/lib/env.ts`
  - `src/lib/env.test.ts`
  - `src/daily.ts`
  - `README.md`
  - `CLAUDE.md`

- Date: 2026-02-16
- Symptom:
  - `run:daily` が `missing revert data` で失敗した際、`run:daily` が `exit 1)` になり以降のステップが中断され、failure report がコミットされない
- Evidence (ログ/tx/stacktrace/URL):
  - 失敗実行時に job が `Run daily bot` で停止し、`Commit reports` step が実行されない設計だった
  - 事故時の `run-*.failure.json` だけではなく、workflow 上のコミット自体が残らない状態
- Root Cause:
  - ワークフローで `run:daily` の失敗時にジョブ終了扱いになり、`if` 条件がなく `Commit reports` が到達不能だった
- Fix:
  - `.github/workflows/daily.yml` の `Run daily bot` に `id: daily` と `continue-on-error: true` を付与
  - `Commit reports` に `if: always()` を付与し、失敗時でもレポートをコミットする
  - 最後に `Fail job if daily failed` を追加し、`steps.daily.outcome == 'failure'` なら `exit 1`
  - `push/pull_request` で軽量検証を行う `.github/workflows/ci.yml` を追加（`npm ci` / `npm run lint` / `npm test`）
- Prevent Recurrence (再発防止):
  - 失敗時でも artifacts を残すことをワークフロー契約として確認（`if: always()` の存在を保守）
  - 主要 step の順序変更前に `git diff` で failure report コミット可否をレビューする運用を追加
- Files Changed:
  - `.github/workflows/daily.yml`
  - `.github/workflows/ci.yml`
  - `CLAUDE.md`

- Date: 2026-02-16
- Symptom:
  - `run:daily` が `missing revert data (action=\"estimateGas\")` で停止し、トランザクション原因（宛先/データ/残高）を確定できなかった
- Evidence (ログ/tx/stacktrace/URL):
  - 実ログ: `FATAL: ... missing revert data`
  - 事前検証で `transfer` 実行前の残高不一致を確認できる設計が未実装だった
- Root Cause:
  - 送信前ガードが不足し、`estimateGas` が内部で revert しても tx コンテキストが欠落していた
- Fix:
  - `src/lib/env.ts` で `SINK_ADDRESS` のゼロアドレス禁止を追加
  - `src/lib/env.test.ts` にゼロアドレス拒否テストを追加
  - `src/daily.ts` で transfer/approve 前に `balanceOf` と `sink`/`amount` をログ出力
  - `src/daily.ts` で `estimateGas/send/waitAndVerify` 失敗時に `to/from/data/nonce/feeFields` を含む再送信可能なエラーログで rethrow
- Prevent Recurrence (テスト/チェック追加内容):
  - `src/lib/env.test.ts` のゼロアドレス拒否テスト
- Files Changed:
  - `src/lib/env.ts`
  - `src/lib/env.test.ts`
  - `src/daily.ts`

- Date: 2026-02-16
- Symptom:
  - `run:daily` が `missing revert data` (`estimateGas`) で停止し、`SINK` が誤った種類（ゼロ/Token宛先）または残高不足による失敗が切り分けできなかった
- Evidence (ログ/tx/stacktrace/URL):
  - `FATAL: missing revert data ... estimateGas ...`
  - `SINK_ADDRESS` が `0x000...0000` または `0x20c000...` の場合は事前チェックを追加する前提
- Root Cause:
  - 送信前の必須バリデーション（Sink 妥当性・残高）と失敗時コンテキスト（to/from/data/nonce/feeFields）をログへ必須化していなかった
- Fix:
  - `src/lib/env.ts` で `SINK_ADDRESS` をゼロアドレス、TIP-20 prefix（`0x20c000000000000000000000`）で即エラー
  - `src/lib/env.test.ts` にゼロ/`TIP-20 prefix`拒否テストを追加
  - `src/daily.ts` で transfer 前に `balanceOf` と `transferAmount/sink` をトークン別にログ出力
  - `src/daily.ts` で `estimateGas/send/waitAndVerify` 失敗時に `to/from/data/nonce/feeFields` を含む再送信可能なエラーメッセージへ rethrow
- Prevent Recurrence (テスト/チェック追加内容):
  - `src/lib/env.test.ts`（ゼロアドレス／TIP-20 prefix拒否テスト）
- Files Changed:
  - `src/lib/env.ts`
  - `src/lib/env.test.ts`
  - `src/daily.ts`
  - `README.md`
  - `CLAUDE.md`
