# CLAUDE.md â€” Non-negotiables / Mistake Log

## Non-negotiables (çµ¶å¯¾éµå®ˆ)
- æ¨æ¸¬ãƒ»ä¸€èˆ¬è«–ã§æ–­å®šã—ãªã„ï¼ˆæ ¹æ‹ : å®Ÿã‚³ãƒ¼ãƒ‰/å®Ÿãƒ­ã‚°/å®Ÿè¡Œçµæœ/å‚ç…§URLï¼‰
- ä¾‹å¤–ã®æ¡ã‚Šã¤ã¶ã—ç¦æ­¢ï¼ˆcatchã—ã¦é»™æ®º/ãƒ­ã‚°ç„¡åŠ¹åŒ–/ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ–/ãƒªãƒˆãƒ©ã‚¤ã§éš ã™/ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ•ãƒ©ã‚°ã§æ­¢ã‚ã‚‹ç­‰ï¼‰
- å®‰æ˜“ãªãƒ¯ãƒ¼ã‚¯ã‚¢ãƒ©ã‚¦ãƒ³ãƒ‰ç¦æ­¢ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå¢—ã‚„ã™ã€ãƒªãƒˆãƒ©ã‚¤å¢—ã‚„ã™ã ã‘ç­‰ï¼‰
- fauceté–¢é€£ã‚³ãƒ¼ãƒ‰ã‚’å…¥ã‚Œãªã„ï¼ˆtempo_fundAddressç­‰ï¼‰
- ä»•æ§˜å¤‰æ›´ã‚’ä¼´ã†åºƒç¯„å›²ãƒªãƒ•ã‚¡ã‚¯ã‚¿ã‚„ç ´å£Šçš„å¤‰æ›´ç¦æ­¢
- è¨¼æ‹ ãªã—ã®åŸå› ç‰¹å®šãƒ»ä¿®æ­£ç¢ºå®šç¦æ­¢

## Definition of Done
- `npm ci && npm run lint && npm test` ãŒé€šã‚‹
- `npm run run:daily` ãŒ reports/ ã« JSON ã‚’ç”Ÿæˆã™ã‚‹
- GitHub Actions ãŒæ¯æ—¥å®Ÿè¡Œã—ã€reports/ ã‚’ commit ã™ã‚‹

## Mistake Logï¼ˆä¿®æ­£ã®ãŸã³ã«å¿…ãšè¿½è¨˜ã™ã‚‹ï¼‰
ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆå¿…é ˆï¼‰:
- Date:
- Symptom:
- Evidence (ãƒ­ã‚°/tx/stacktrace/URL):
- Root Cause:
- Fix:
- Prevent Recurrence (ãƒ†ã‚¹ãƒˆ/ãƒã‚§ãƒƒã‚¯è¿½åŠ å†…å®¹):
- Files Changed:
- Date: 2026-02-16
- Symptom:
  - `estimateGas` å¤±æ•—æ™‚ã«åŸå› ãŒ opaque ã§ã€Tempoå›ºæœ‰ã®å¤±æ•—è¦å› ï¼ˆTIP-403 / fee preference / max_fee pre-deduct / receipt fee fieldsï¼‰ã‚’ run 1å›ã§ç¢ºå®šã§ããªã‹ã£ãŸ
- Evidence (ãƒ­ã‚°/tx/stacktrace/URL):
  - `missing revert data` ã§åœæ­¢ã—ã€é€ä¿¡å‰åˆ¤å®šã§è½ã¨ã™ã¹ãæ¡ä»¶ã‚’ tx å®Ÿè¡ŒçµŒè·¯ã§åˆã‚ã¦æ¤œå‡ºã—ã¦ã„ãŸ
  - Tempoä»•æ§˜URL:
    - `https://docs.tempo.xyz/protocol/tip20/spec`
    - `https://docs.tempo.xyz/protocol/tip403/spec`
    - `https://docs.tempo.xyz/protocol/fees/spec-fee`
    - `https://docs.tempo.xyz/protocol/fees/spec-fee-amm`
    - `https://docs.chainstack.com/reference/tempo-eth-gettransactionreceipt`
- Root Cause:
  - äº‹å‰ç¢ºå®šåˆ¤å®šã®ä¸è¶³ï¼ˆTIP-403 policy / fee token preference / max_fee æ®‹é«˜ï¼‰
  - report ãŒ receipt ã® `feeToken/feePayer` ã‚’å¿…é ˆæ¤œè¨¼ã—ã¦ãŠã‚‰ãšã€Tempoæ‹¡å¼µé …ç›®æ¬ è½ã‚’è¦‹é€ƒã™è¨­è¨ˆã ã£ãŸ
- Fix:
  - `FeeManager.setUserToken(alphaUSD)` ã‚’æ—¥æ¬¡å…ˆé ­ tx ã«è¿½åŠ 
  - TIP-20 preflight (`paused/currency/transferPolicyId/isAuthorized`) ã‚’ transfer/approve å‰ã«å®Ÿæ–½
  - `max_fee = gas_limit * gas_price` ã‚’ atto->micro ã«åˆ‡ã‚Šä¸Šã’å¤‰æ›ã—ã€alphaUSD æ®‹é«˜ã§é€ä¿¡å‰ fail
  - report ã‚’æ‹¡å¼µã— `gasUsed/effectiveGasPrice/feeToken/feePayer/receiptRaw` ã‚’å„ tx ã«å¿…é ˆä¿å­˜
  - ä¾‹å¤–æ™‚ã« `run-*.failure.json` ã‚’ä¿å­˜ã—ã¦ `step/preflight/error` ã‚’æ®‹ã—ã¦ `exit(1)` ç¶­æŒ
- Prevent Recurrence (ãƒ†ã‚¹ãƒˆ/ãƒã‚§ãƒƒã‚¯è¿½åŠ å†…å®¹):
  - `src/lib/feeMath.test.ts` ã§ `ceil(attodollars/1e12)` å¢ƒç•Œãƒ†ã‚¹ãƒˆã‚’è¿½åŠ 
  - `src/lib/report.test.ts` ã§ `feeToken/feePayer` æŠ½å‡ºå¿…é ˆãƒ†ã‚¹ãƒˆã‚’è¿½åŠ 
- Files Changed:
  - `src/daily.ts`
  - `src/lib/report.ts`
  - `src/lib/feeMath.ts`
  - `src/lib/feeMath.test.ts`
  - `src/lib/report.test.ts`
  - `src/tempo.ts`
  - `src/abi/erc20.ts`
  - `src/abi/feeManager.ts`
  - `src/abi/tip403.ts`
  - `README.md`
  - `CLAUDE.md`

- Date: 2026-02-16
- Symptom:
  - `run:daily` ãŒ `missing revert data ... estimateGas` ã§çµ‚äº†ã—ã€åŸå› ï¼ˆSINKèª¤è¨­å®š/æ®‹é«˜ä¸è¶³ï¼‰ã‚’è»¢é€å‰ã«ç¢ºå®šã§ããªã‹ã£ãŸ
- Evidence (ãƒ­ã‚°/tx/stacktrace/URL):
  - å®Ÿé‹ç”¨ãƒ­ã‚°: `FATAL: ... missing revert data`ï¼ˆé€ä¿¡å‰ã« `estimateGas` ã«å¤±æ•—ï¼‰
  - `SINK_ADDRESS` ã®ã‚¼ãƒ­ã‚¢ãƒ‰ãƒ¬ã‚¹è¨±å®¹ã€TIP-20 prefix é€ä¿¡å…ˆè¨±å®¹ãŒæ®‹ã£ã¦ã„ãŸ
- Root Cause:
  - `env` ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ transfer å‰ã®æ®‹é«˜æ¤œè¨¼ãŒä¸è¶³ã—ã€`estimateGas` è½ã¡æ™‚ã«å¿…è¦ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ãŒå†ç¾ãƒ­ã‚°ã¸æ®‹ã‚‰ãªã‹ã£ãŸ
- Fix:
  - `src/lib/env.ts` ã§ `SINK_ADDRESS` ã®ã‚¼ãƒ­ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ TIP-20 ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’ `throw` ã§å³æ‹’å¦
  - `src/daily.ts` ã§ `transfer` å„ãƒˆãƒ¼ã‚¯ãƒ³ã® `balanceOf(sender)` ã‚’å–å¾—ã—ä¸è¶³æ™‚ã¯æ˜ç¤ºã‚¨ãƒ©ãƒ¼
  - `src/daily.ts` ã§ `transfer` ã® `estimateGas` å¤±æ•—æ™‚ã« tokenå/tokenã‚¢ãƒ‰ãƒ¬ã‚¹/wallet/sink/amount/balance/nonce/feeFields ã‚’å†ç¾å¯èƒ½ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ãƒ­ã‚°å†é€
- Prevent Recurrence (ãƒ†ã‚¹ãƒˆ/ãƒã‚§ãƒƒã‚¯è¿½åŠ å†…å®¹):
  - `src/lib/env.test.ts` ã«ã‚¼ãƒ­/`TIP-20 prefix`æ‹’å¦ã‚±ãƒ¼ã‚¹ã‚’è¿½åŠ 
  - `src/daily.ts` ã® transfer ã§ `balance` ãƒ­ã‚°ã¨ `estimateGas` ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ­ã‚°ã‚’ç¶­æŒ
- Files Changed:
  - `src/lib/env.ts`
  - `src/lib/env.test.ts`
  - `src/daily.ts`
  - `README.md`
  - `CLAUDE.md`

- Date: 2026-02-16
- Symptom:
  - `run:daily` ãŒ `missing revert data` ã§å¤±æ•—ã—ãŸéš›ã€`run:daily` ãŒ `exit 1)` ã«ãªã‚Šä»¥é™ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒä¸­æ–­ã•ã‚Œã€failure report ãŒã‚³ãƒŸãƒƒãƒˆã•ã‚Œãªã„
- Evidence (ãƒ­ã‚°/tx/stacktrace/URL):
  - å¤±æ•—å®Ÿè¡Œæ™‚ã« job ãŒ `Run daily bot` ã§åœæ­¢ã—ã€`Commit reports` step ãŒå®Ÿè¡Œã•ã‚Œãªã„è¨­è¨ˆã ã£ãŸ
  - äº‹æ•…æ™‚ã® `run-*.failure.json` ã ã‘ã§ã¯ãªãã€workflow ä¸Šã®ã‚³ãƒŸãƒƒãƒˆè‡ªä½“ãŒæ®‹ã‚‰ãªã„çŠ¶æ…‹
- Root Cause:
  - ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ `run:daily` ã®å¤±æ•—æ™‚ã«ã‚¸ãƒ§ãƒ–çµ‚äº†æ‰±ã„ã«ãªã‚Šã€`if` æ¡ä»¶ãŒãªã `Commit reports` ãŒåˆ°é”ä¸èƒ½ã ã£ãŸ
- Fix:
  - `.github/workflows/daily.yml` ã® `Run daily bot` ã« `id: daily` ã¨ `continue-on-error: true` ã‚’ä»˜ä¸
  - `Commit reports` ã« `if: always()` ã‚’ä»˜ä¸ã—ã€å¤±æ•—æ™‚ã§ã‚‚ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚³ãƒŸãƒƒãƒˆã™ã‚‹
  - æœ€å¾Œã« `Fail job if daily failed` ã‚’è¿½åŠ ã—ã€`steps.daily.outcome == 'failure'` ãªã‚‰ `exit 1`
  - `push/pull_request` ã§è»½é‡æ¤œè¨¼ã‚’è¡Œã† `.github/workflows/ci.yml` ã‚’è¿½åŠ ï¼ˆ`npm ci` / `npm run lint` / `npm test`ï¼‰
- Prevent Recurrence (å†ç™ºé˜²æ­¢):
  - å¤±æ•—æ™‚ã§ã‚‚ artifacts ã‚’æ®‹ã™ã“ã¨ã‚’ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å¥‘ç´„ã¨ã—ã¦ç¢ºèªï¼ˆ`if: always()` ã®å­˜åœ¨ã‚’ä¿å®ˆï¼‰
  - ä¸»è¦ step ã®é †åºå¤‰æ›´å‰ã« `git diff` ã§ failure report ã‚³ãƒŸãƒƒãƒˆå¯å¦ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹é‹ç”¨ã‚’è¿½åŠ 
- Files Changed:
  - `.github/workflows/daily.yml`
  - `.github/workflows/ci.yml`
  - `CLAUDE.md`

- Date: 2026-02-16
- Symptom:
  - `run:daily` ãŒ `missing revert data (action=\"estimateGas\")` ã§åœæ­¢ã—ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³åŸå› ï¼ˆå®›å…ˆ/ãƒ‡ãƒ¼ã‚¿/æ®‹é«˜ï¼‰ã‚’ç¢ºå®šã§ããªã‹ã£ãŸ
- Evidence (ãƒ­ã‚°/tx/stacktrace/URL):
  - å®Ÿãƒ­ã‚°: `FATAL: ... missing revert data`
  - äº‹å‰æ¤œè¨¼ã§ `transfer` å®Ÿè¡Œå‰ã®æ®‹é«˜ä¸ä¸€è‡´ã‚’ç¢ºèªã§ãã‚‹è¨­è¨ˆãŒæœªå®Ÿè£…ã ã£ãŸ
- Root Cause:
  - é€ä¿¡å‰ã‚¬ãƒ¼ãƒ‰ãŒä¸è¶³ã—ã€`estimateGas` ãŒå†…éƒ¨ã§ revert ã—ã¦ã‚‚ tx ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãŒæ¬ è½ã—ã¦ã„ãŸ
- Fix:
  - `src/lib/env.ts` ã§ `SINK_ADDRESS` ã®ã‚¼ãƒ­ã‚¢ãƒ‰ãƒ¬ã‚¹ç¦æ­¢ã‚’è¿½åŠ 
  - `src/lib/env.test.ts` ã«ã‚¼ãƒ­ã‚¢ãƒ‰ãƒ¬ã‚¹æ‹’å¦ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ 
  - `src/daily.ts` ã§ transfer/approve å‰ã« `balanceOf` ã¨ `sink`/`amount` ã‚’ãƒ­ã‚°å‡ºåŠ›
  - `src/daily.ts` ã§ `estimateGas/send/waitAndVerify` å¤±æ•—æ™‚ã« `to/from/data/nonce/feeFields` ã‚’å«ã‚€å†é€ä¿¡å¯èƒ½ãªã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã§ rethrow
- Prevent Recurrence (ãƒ†ã‚¹ãƒˆ/ãƒã‚§ãƒƒã‚¯è¿½åŠ å†…å®¹):
  - `src/lib/env.test.ts` ã®ã‚¼ãƒ­ã‚¢ãƒ‰ãƒ¬ã‚¹æ‹’å¦ãƒ†ã‚¹ãƒˆ
- Files Changed:
  - `src/lib/env.ts`
  - `src/lib/env.test.ts`
  - `src/daily.ts`

- Date: 2026-02-16
- Symptom:
  - `run:daily` ãŒ `missing revert data` (`estimateGas`) ã§åœæ­¢ã—ã€`SINK` ãŒèª¤ã£ãŸç¨®é¡ï¼ˆã‚¼ãƒ­/Tokenå®›å…ˆï¼‰ã¾ãŸã¯æ®‹é«˜ä¸è¶³ã«ã‚ˆã‚‹å¤±æ•—ãŒåˆ‡ã‚Šåˆ†ã‘ã§ããªã‹ã£ãŸ
- Evidence (ãƒ­ã‚°/tx/stacktrace/URL):
  - `FATAL: missing revert data ... estimateGas ...`
  - `SINK_ADDRESS` ãŒ `0x000...0000` ã¾ãŸã¯ `0x20c000...` ã®å ´åˆã¯äº‹å‰ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ ã™ã‚‹å‰æ
- Root Cause:
  - é€ä¿¡å‰ã®å¿…é ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆSink å¦¥å½“æ€§ãƒ»æ®‹é«˜ï¼‰ã¨å¤±æ•—æ™‚ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆto/from/data/nonce/feeFieldsï¼‰ã‚’ãƒ­ã‚°ã¸å¿…é ˆåŒ–ã—ã¦ã„ãªã‹ã£ãŸ
- Fix:
  - `src/lib/env.ts` ã§ `SINK_ADDRESS` ã‚’ã‚¼ãƒ­ã‚¢ãƒ‰ãƒ¬ã‚¹ã€TIP-20 prefixï¼ˆ`0x20c000000000000000000000`ï¼‰ã§å³ã‚¨ãƒ©ãƒ¼
  - `src/lib/env.test.ts` ã«ã‚¼ãƒ­/`TIP-20 prefix`æ‹’å¦ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ 
  - `src/daily.ts` ã§ transfer å‰ã« `balanceOf` ã¨ `transferAmount/sink` ã‚’ãƒˆãƒ¼ã‚¯ãƒ³åˆ¥ã«ãƒ­ã‚°å‡ºåŠ›
  - `src/daily.ts` ã§ `estimateGas/send/waitAndVerify` å¤±æ•—æ™‚ã« `to/from/data/nonce/feeFields` ã‚’å«ã‚€å†é€ä¿¡å¯èƒ½ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¸ rethrow
- Prevent Recurrence (ãƒ†ã‚¹ãƒˆ/ãƒã‚§ãƒƒã‚¯è¿½åŠ å†…å®¹):
  - `src/lib/env.test.ts`ï¼ˆã‚¼ãƒ­ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼TIP-20 prefixæ‹’å¦ãƒ†ã‚¹ãƒˆï¼‰
- Files Changed:
  - `src/lib/env.ts`
  - `src/lib/env.test.ts`
  - `src/daily.ts`
  - `README.md`
  - `CLAUDE.md`
- Date: 2026-02-18
- Symptom:
  - origin/main ‚ÌŠm”Fè‡igit ls-tree -r --name-only origin/main, git cat-file -s origin/main:secrets/wallet.encj‚ğÀ{‚µAwallet.enc ‚ğ’ÇÕ‰^—p‘ÎÛ‚Æ‚µ‚ÄÄŠm”F‚µ‚½
- Evidence (ƒƒO/tx/stacktrace/URL):
  - git ls-tree -r --name-only origin/main | Select-String -Pattern "secrets/wallet.enc"
  - git cat-file -s origin/main:secrets/wallet.enc
- Root Cause:
  - wallet.enc ‚Ì’ÇÕó‘Ô‚ğ push ‘O“_ŒŸ‚¹‚¸‚É‰^—p‚ği‚ß‚éƒŠƒXƒN
- Fix:
  - wallet.enc ‚ğÅ¬·•ª‚Å staging ‚µAgit commit ‚Ö‚¿‚Ş‰^—p‚ğ–¾¦
- Prevent Recurrence (Ä”­–h~):
  - origin/main ã‚Ì wallet.enc ‚Ì—L–³‚ÆƒTƒCƒY‚ğ push ‘O‚É–ˆ‰ñŠm”F
- Files Changed:
  - secrets/wallet.enc
  - CLAUDE.md
